<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
   <link rel="stylesheet" href="/medium-articles/libs/highlight/styles/github.min.css">
   
  <link rel="stylesheet" href="/medium-articles/css/franklin.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic|Source+Code+Pro:400,700" type="text/css">
<link rel="stylesheet" href="/medium-articles/css/font-awesome.min.css">
<link rel="stylesheet" href="/medium-articles/css/celeste.min.css">
<link rel="stylesheet" href="/medium-articles/css/custom.css">

<link rel="icon" type="image/png" sizes="192x192" href="/medium-articles/assets/favicon.png">
<link rel="shortcut icon" href="/medium-articles/assets/favicon.ico">


   <title>Stirred Reactor Model Predictive Control</title>  
</head>
<body>
  <header>
<nav class="nav-main">
  <ul>
    <li class="logo"><a class="hvr-ripple-out" href="/medium-articles/">W</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/medium/">Medium Articles</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/transport-phenomena/">Transport Phenomena</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/engenharia-de-reatores/">Engenharia de Reatores</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/bookmarks/">Links</a></li>
  </ul>
</nav>
</header>


<!-- Content appended here -->
<div class="franklin-content"><h1 id="stirred_reactor_model_predictive_control"><a href="#stirred_reactor_model_predictive_control" class="header-anchor">Stirred Reactor Model Predictive Control</a></h1>
<h2 id="import_tools"><a href="#import_tools" class="header-anchor">Import tools</a></h2>
<pre><code class="language-python">&#37;matplotlib inline</code></pre>
<pre><code class="language-python">from casadi import SX
from casadi import DM
from casadi import Function
from casadi import nlpsol
from casadi import vertcat
import numpy as np
import matplotlib.pyplot as plt</code></pre>
<h2 id="create_models"><a href="#create_models" class="header-anchor">Create models</a></h2>
<pre><code class="language-python">class PlantModel:
    &quot;&quot;&quot; Minimal implementation of system dynamics. &quot;&quot;&quot;
    def __init__&#40;self&#41;:
        x &#61; SX.sym&#40;&quot;x&quot;, 3&#41; # Concentrations
        k &#61; SX.sym&#40;&quot;k&quot;, 1&#41; # Rate constant
        N &#61; SX.sym&#40;&quot;N&quot;, 1&#41; # System size
        
        # Total flow rate.
        Ndot &#61; SX.sym&#40;&quot;Ndot&quot;, 1&#41;
        
        # Feed flow rates.
        ndot &#61; SX.sym&#40;&quot;ndot&quot;, 3&#41;
        ndot&#91;1&#93; &#61; Ndot - ndot&#91;0&#93;
        ndot&#91;2&#93; &#61; 0

        # Production rates of species.
        vdot &#61; k * x&#91;0&#93; * DM&#40;&#91;-1, 0, 1&#93;&#41;
        
        # Symbolic balance equation.
        xdot &#61; &#40;ndot - Ndot * x &#43; vdot&#41; / N
        
        # Functional balance equation.
        xrhs &#61; Function&#40;
            &quot;xdot&quot;,
            &#91;x, ndot&#91;0&#93;, Ndot, N, k&#93;,
            &#91;xdot&#93;,
            &#91;&quot;x&quot;, &quot;ndot_A&quot;, &quot;Ndot&quot;, &quot;N&quot;, &quot;k&quot;&#93;,
            &#91;&quot;xdot&quot;&#93;
        &#41;

        self._states &#61; x
        self._balance_eqns_sym &#61; xdot
        self._balance_eqns_fun &#61; xrhs
    
    @property
    def states&#40;self&#41;:
        return self._states

    @property
    def balance_eqns_sym&#40;self&#41;:
        return self._balance_eqns_sym
    
    @property
    def balance_eqns_fun&#40;self&#41;:
        return self._balance_eqns_fun</code></pre>
<pre><code class="language-python">class InstantiatedPlant:
    &quot;&quot;&quot; Instantiation of dynamics with fixed parameters. &quot;&quot;&quot;
    def __init__&#40;self, model, k, N, Ndot, tau&#41;:
        self._states &#61; model.states
        self._rhs &#61; model.balance_eqns_fun
        self._pars &#61; &#91;Ndot, N, k&#93;
        self._tau &#61; tau
    
    @property
    def states&#40;self&#41;:
        return self._states
    
    def step_euler&#40;self, xn, pn&#41;:
        return xn &#43; self._tau * self._rhs&#40;xn, pn, *self._pars&#41;</code></pre>
<pre><code class="language-python">class ControlsMPC:
    &quot;&quot;&quot; A simple MPC for a given plant. &quot;&quot;&quot;
    def __init__&#40;self, plant, Np, R, S&#41;:
        self._plant &#61; plant
        self._horizon &#61; Np

        # TODO instead of computing cost directly in _integrate
        # just store the values in arrays and provide these
        # in optimize so that we can play for parametrization.
        self._R &#61; R
        self._S &#61; S

        self._p &#61; SX.sym&#40;&quot;p&quot;, Np&#43;1&#41;
        self._xp &#61; SX.sym&#40;&quot;xp&quot;, Np&#43;1&#41;
        
        self._x0 &#61; SX.sym&#40;&quot;x0&quot;, 3, 1&#41;
        self._xt &#61; SX.sym&#40;&quot;xt&quot;, 3, Np&#43;1&#41;
        self._xt&#91;:, 0&#93; &#61; self._x0
        
        J, F &#61; self._integrate&#40;&#41;
        self._cost &#61; J
        self._sim &#61; F

    def _integrate&#40;self&#41;:
        print&#40;&quot;Initial call to MPC: symbolic integration&quot;&#41;

        J &#61; 0
        x &#61; self._xt&#91;:, 0&#93;
        
        for ts in range&#40;1, self._horizon&#43;1&#41;:
            x &#61; self._plant.step_euler&#40;x, self._p&#91;ts&#93;&#41;
            self._xt&#91;:, ts&#93; &#61; x
            
            # TODO: implement an actual scaling so that both have
            # the same magnitude and Q, R become scale-independent&#33;
            scale_error  &#61; x&#91;2&#93; - self._xp&#91;ts&#93;
            scale_change &#61; self._p&#91;ts&#93; - self._p&#91;ts-1&#93; 
            # scale_error /&#61; &#40;x&#91;2&#93; &#43; 1.0e-15&#41;
            # scale_change /&#61; &#40;self._p&#91;ts&#93; &#43; 1.0e-15&#41;
            
            cost_error &#61; pow&#40;scale_error, 2&#41;
            cost_change &#61; self._R * pow&#40;scale_change, 2&#41;

            J &#43;&#61; cost_error &#43; cost_change

        J &#43;&#61; self._S * pow&#40;x&#91;2&#93; - self._xp&#91;-1&#93;, 2&#41;
        F &#61; Function&#40;&quot;sim&quot;, &#91;self._x0, self._p&#93;, &#91;self._xt&#93;&#41;
        
        return J, F

    def optimize&#40;self, x0, p0, xsp, pmax&#41;:           
        # Constraint *negative time* command to the current value.
        g &#61; &#91;self._p&#91;0&#93; - p0&#93;
        
        # XXX: abuse of notation&#33; Notice below that the dictionary
        # *unknowns* &quot;x&quot; are set to &#96;self._p&#96;, while *parameters*
        # &quot;p&quot; are given the *x&#39;s*. This is because we are finding
        # the optimal controls here and already know the target
        # profile and initial states for concentrations *x*&#33;
        solver &#61; nlpsol&#40;&quot;solver&quot;, &quot;ipopt&quot;, &#123;
            &quot;f&quot;: self._cost,
            &quot;x&quot;: self._p, 
            &quot;g&quot;: vertcat&#40;*g&#41;,
            &quot;p&quot;: vertcat&#40;self._xp, self._x0&#41;
        &#125;&#41;
        
        p &#61; &#91;*xsp, *x0&#93;
        guess &#61; np.ones&#40;self._horizon&#43;1&#41;

        solution &#61; solver&#40;x0&#61;guess, p&#61;p, lbx&#61;0, ubx&#61;pmax, lbg&#61;0, ubg&#61;0&#41;
        popt &#61; solution&#91;&quot;x&quot;&#93;.full&#40;&#41;.ravel&#40;&#41;
        xt &#61; self._sim&#40;x0, popt&#41;.full&#40;&#41;.T

        return popt, xt, solution</code></pre>
<h2 id="solution_workflow"><a href="#solution_workflow" class="header-anchor">Solution workflow</a></h2>
<h3 id="create_dynamics"><a href="#create_dynamics" class="header-anchor">Create dynamics</a></h3>
<pre><code class="language-python">model &#61; PlantModel&#40;&#41;
model.balance_eqns_fun</code></pre>
<h3 id="provide_parameters"><a href="#provide_parameters" class="header-anchor">Provide parameters</a></h3>
<pre><code class="language-python">k &#61; 10.0
N &#61; 500.0
Ndot &#61; 3.0

ndot_A_max &#61; 0.9 * Ndot
ndot_A_ini &#61; 0.5 * Ndot

Np &#61; 200
tau &#61; 10.0

R &#61; 0.1
S &#61; 100.0

x0 &#61; &#91;0.0, 1.0, 0.0&#93;

xsp &#61; np.zeros&#40;Np&#43;1&#41;
xsp&#91;:3*Np//5&#93; &#61; 0.2
xsp&#91;3*Np//5:&#93; &#61; 0.5</code></pre>
<h3 id="setup_controller"><a href="#setup_controller" class="header-anchor">Setup controller</a></h3>
<pre><code class="language-python">plant &#61; InstantiatedPlant&#40;model, k, N, Ndot, tau&#41;

mpc &#61; ControlsMPC&#40;plant, Np, R, S&#41;</code></pre>
<h3 id="optimize_and_retrieve_results"><a href="#optimize_and_retrieve_results" class="header-anchor">Optimize and retrieve results</a></h3>
<pre><code class="language-python">popt, xt, solution &#61; mpc.optimize&#40;x0, ndot_A_ini, xsp, ndot_A_max&#41;</code></pre>
<h3 id="display_results"><a href="#display_results" class="header-anchor">Display results</a></h3>
<pre><code class="language-python">xsp_max &#61; np.clip&#40;xsp &#43; 0.05, 0.0, 1.0&#41;
xsp_min &#61; np.clip&#40;xsp - 0.05, 0.0, 1.0&#41;
good &#61; &#40;xt&#91;:, 2&#93; &gt;&#61; xsp_min&#41; &amp; &#40;xt&#91;:, 2&#93; &lt;&#61; xsp_max&#41;

steps &#61; list&#40;range&#40;Np&#43;1&#41;&#41;
quality &#61; 100 * sum&#40;good.astype&#40;&quot;u8&quot;&#41;&#41; / len&#40;good&#41;

cmd &#61; list&#40;popt / Ndot&#41;
cmd.append&#40;cmd&#91;-1&#93;&#41;

plt.style.use&#40;&quot;default&quot;&#41;
fig &#61; plt.figure&#40;figsize&#61;&#40;12, 6&#41;&#41;
plt.grid&#40;linestyle&#61;&quot;:&quot;&#41;

plt.plot&#40;steps, xt&#91;:, 0&#93;, label&#61;&quot;&#36;X_A&#36;&quot;&#41;
plt.plot&#40;steps, xt&#91;:, 1&#93;, label&#61;&quot;&#36;X_B&#36;&quot;&#41;
plt.plot&#40;steps, xt&#91;:, 2&#93;, lw&#61;4, label&#61;&quot;&#36;X_C&#36;&quot;&#41;

plt.step&#40;steps, xsp_max, &quot;m--&quot;, lw&#61;2, label&#61;&quot;_none_&quot;, where&#61;&quot;post&quot;&#41;
plt.step&#40;steps, xsp_min, &quot;m--&quot;, lw&#61;2, label&#61;&quot;_none_&quot;, where&#61;&quot;post&quot;&#41;
plt.step&#40;steps, xsp, &quot;m-&quot;, lw&#61;1, label&#61;&quot;&#36;X_C&#36; &#40;target&#41;&quot;, where&#61;&quot;post&quot;&#41;
plt.fill_between&#40;steps, xsp_min, xsp_max, where&#61;good, alpha&#61;0.3&#41;

plt.step&#40;&#91;-1, *steps&#93;, cmd, &quot;r&quot;, lw&#61;2, label&#61;&quot;&#36;Q_A&#36; &#40;relative&#41;&quot;, where&#61;&quot;post&quot;&#41;

plt.title&#40;f&quot;Expected quality level at &#123;quality:.1f&#125;&#37;&quot;&#41;
plt.ylabel&#40;&quot;Mole fractions and relative flow rate of A&quot;&#41;
plt.xlabel&#40;&quot;Action step number over prediction horizon&quot;&#41;
plt.legend&#40;loc&#61;&quot;upper center&quot;, fancybox&#61;True, framealpha&#61;1.0, ncol&#61;6&#41;
plt.xlim&#40;-1, Np&#41;
plt.ylim&#40;0, 1&#41;
plt.tight_layout&#40;&#41;</code></pre>
<div class="page-foot">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Walter Dal'Maz Silva -
    Built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>.
</div>
</div><!-- CONTENT ENDS HERE -->
    
    
        <script src="/medium-articles/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();hljs.configure({tabReplace: '    '});</script>

    
  </body>
</html>
