<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
   <link rel="stylesheet" href="/medium-articles/libs/katex/katex.min.css">
     
   <link rel="stylesheet" href="/medium-articles/libs/highlight/styles/github.min.css">
   
  <link rel="stylesheet" href="/medium-articles/css/franklin.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,700,400italic|Source+Code+Pro:400,700" type="text/css">
<link rel="stylesheet" href="/medium-articles/css/font-awesome.min.css">
<link rel="stylesheet" href="/medium-articles/css/celeste.min.css">
<link rel="stylesheet" href="/medium-articles/css/custom.css">

<link rel="icon" type="image/png" sizes="192x192" href="/medium-articles/assets/favicon.png">
<link rel="shortcut icon" href="/medium-articles/assets/favicon.ico">


   <title>Transient heat transfer</title>  
</head>
<body>
  <header>
<nav class="nav-main">
  <ul>
    <li class="logo"><a class="hvr-ripple-out" href="/medium-articles/">W</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/medium/">Medium Articles</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/transport-phenomena/">Transport Phenomena</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/julia-para-cientistas/">Julia para Cientistas</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/engenharia-de-reatores/">Engenharia de Reatores</a></li>
    <li class="hvr-underline-reveal"><a href="/medium-articles/content/bookmarks/">Links</a></li>
  </ul>
</nav>
</header>


<!-- Content appended here -->
<div class="franklin-content">
<h1 id="transient_heat_transfer"><a href="#transient_heat_transfer" class="header-anchor">Transient heat transfer</a></h1>

<h2 id="first_problem"><a href="#first_problem" class="header-anchor">First problem</a></h2>
<p>Implementation of section 2.3 of Nithiarasu <em>et al.</em> &#40;2016&#41; of a transient heat transfer problem. This is the logical extension of what has been explored in a previous <a href="./01-Composite-Conduction">study</a>. The overall problem is stated in terms of the inertia matrix \(\mathbf{C}\), the stiffness \(\mathbf{K}\) and the forcing function \(\mathbf{f}\). The following first order differential equation of temperature \(\mathcal{T}\) is to be solved:</p>
\[
\mathbf{C}\dot{\mathcal{T}}+\mathbf{K}\mathcal{T}=\mathbf{f}
\]
<p>Notice here that the temperature \(\mathcal{T}\) here is a vector corresponding to the three problem components, the steel part, the furnace gas, and the outer refractory walls.</p>
<p>Because the model is stated in lumped form, <em>i.e.</em> simplified to a zero-dimensional space, we add a phase of calculation of the <em>heat capacities</em> of materials in compatible units to remain within the formulation proposed in the reference. In this lumped format, the elements of matrix \(\mathbf{C}\) are given in units of energy per unit temperature because they already incorporate the effect bodies masses through \(C_{i,i}=m_i{}c_{P,i}\) where \(i\) indicates de component index.</p>
<p>To get a dynamics that is interpretable in the real world we will start by computing reasonable orders of magnitude of the \(C_{i,i}\) by providing the masses of the bodies and typical values of specific heats for the involved materials. Considering a steel sphere of 10 cm placed <strong>floating</strong> in a 40 cm air environment limited by a spherical refractory with outer shell of 60 cm we can estimate these masses, in the same order, as:</p>
<pre><code class="language-julia">m &#61; 1u&quot;kg&quot; * &#91;4.2, 0.033, 240.0&#93;</code></pre>
<p>Next we provide the specific heats of the materials already multiplied by the above masses:</p>
<pre><code class="language-julia">cp&#40;T&#41; &#61; m&#91;1&#93; * 6.00e&#43;03u&quot;J/&#40;kg*K&#41;&quot;
cg&#40;T&#41; &#61; m&#91;2&#93; * 1.00e&#43;03u&quot;J/&#40;kg*K&#41;&quot;
cw&#40;T&#41; &#61; m&#91;3&#93; * 9.00e&#43;02u&quot;J/&#40;kg*K&#41;&quot;</code></pre>
<p>Since our goal is to make the problem fully treated in matrix form, we stack the specific heats together. Since matrix \(\mathrm{C}\) is diagonal and composed by these specific heats, its inverse is simply the reciprocal of its diagonal elements, what is trivial to prove. This allows the problem to be reworked as</p>
\[
\dot{\mathcal{T}}+\mathbf{C}^{-1}\mathbf{K}\mathcal{T}=\mathbf{C}^{-1}\mathbf{f}
\]
<p>Setting the derivative term to be alone could be interesting for testing different time-stepping strategies, for instance. Matrix \(\mathrm{C}^{-1}\) is provided by <code>inertiainv</code> below:</p>
<pre><code class="language-julia">specificheat&#40;T&#41; &#61; &#91;cp&#40;T&#91;1&#93;&#41;; cg&#40;T&#91;2&#93;&#41;; cw&#40;T&#91;3&#93;&#41;&#93;

inertiainv&#40;T&#41; &#61; diagm&#40;1 ./ specificheat&#40;T&#41;&#41;</code></pre>
<p>We inspect the inverse inertia matrix:</p>
<pre><code class="language-julia">inertiainv&#40;&#91;300.0, 300.0, 300.0&#93;&#41;</code></pre><pre><code class="plaintext code-output">3×3 Matrix{Unitful.Quantity{Float64, 𝚯 𝐓^2 𝐋^-2 𝐌^-1, Unitful.FreeUnits{(J^-1, K), 𝚯 𝐓^2 𝐋^-2 𝐌^-1, nothing}}}:
 3.96825e-5 K J^-1       0.0 K J^-1         0.0 K J^-1
        0.0 K J^-1  0.030303 K J^-1         0.0 K J^-1
        0.0 K J^-1       0.0 K J^-1  4.62963e-6 K J^-1</code></pre>
<p>Stiffness matrix \(\mathrm{K}\) in this problem provides the convective heat transfer terms. It is given by</p>
\[
\mathbf{K} = \begin{bmatrix}
h_pA_p  & -h_pA_p         & 0               \\
-h_pA_p & h_pA_p + h_gA_g & -h_gA_g         \\
0       & -h_gA_g         & h_gA_g + h_wA_w
\end{bmatrix}
\]
<p>Since this matrix does not contain any element that depends on temperature it needs to be computed only once and we will not seek an optimized way to evaluate it. The code below is generic for any <em>layered</em> structure as the one being modelled here. Notice that the pairwise interactions lead to a tridiagonal structure.</p>
<pre><code class="language-julia">function stiffness&#40;h, A&#41;
    p &#61; @. h * A
    q &#61; -1 * p&#91;1:end-1&#93;
    p&#91;2:end&#93; -&#61; q
    return diagm&#40;0&#61;&gt;p, -1&#61;&gt;q, 1&#61;&gt;q&#41;
end</code></pre>
<p>For testing its implementation and later simulating the system we provide already the set of convective heat transfer coefficients on <code>h</code> and heat transfer areas in <code>A</code>. The order of magnitude of areas was kept compatible with the geometrical description provided before.</p>
<pre><code class="language-julia">h &#61; &#91;100.0, 100.0, 10.0&#93; * 1u&quot;W/&#40;m^2*K&#41;&quot;
A &#61; &#91;0.032, 0.500, 1.15&#93; * 1u&quot;m^2&quot;

stiffness&#40;h, A&#41;</code></pre><pre><code class="plaintext code-output">3×3 Matrix{Unitful.Quantity{Float64, 𝐋^2 𝐌 𝚯^-1 𝐓^-3, Unitful.FreeUnits{(K^-1, W), 𝐋^2 𝐌 𝚯^-1 𝐓^-3, nothing}}}:
  3.2 W K^-1   -3.2 W K^-1    0.0 W K^-1
 -3.2 W K^-1   53.2 W K^-1  -50.0 W K^-1
  0.0 W K^-1  -50.0 W K^-1   61.5 W K^-1</code></pre>
<p>To conclude problem specification, a function <code>forcing</code> for evaluation of \(\mathbf{f}\) is provided below.  Vector \(\mathbf{f}\) is mainly where the description of radiative heat transfer is represented and is given as:</p>
\[
\mathbf{f} = \begin{bmatrix}
-\epsilon_{p}\sigma{}A_p(\mathcal{T}_p^4-\mathcal{T}_w^4) \\
0 \\
h_wA_wT_a + \epsilon_{p}\sigma{}A_p(\mathcal{T}_p^4-\mathcal{T}_w^4) 
- \epsilon_{w}\sigma{}A_w(\mathcal{T}_w^4-T_a^4)
\end{bmatrix}
\]
<pre><code class="language-julia">function forcing&#40;T, h, A, Ta, ϵp, ϵw&#41;
    f1 &#61; -ϵp*σ*A&#91;1&#93;*&#40;T&#91;1&#93;^4-T&#91;3&#93;^4&#41;
    f3 &#61; h&#91;3&#93;*A&#91;3&#93;*Ta - f1 - ϵw*σ*A&#91;3&#93;*&#40;T&#91;3&#93;^4 - Ta^4&#41;
    return &#91; f1; 0u&quot;W&quot;; f3 &#93;
end</code></pre>
<p>The remaining parameters to close the problem are the emissivity of the materials and external temperature, all provided below.</p>
<pre><code class="language-julia">ϵp &#61; 0.8
ϵw &#61; 0.3
Ta &#61; 313.15u&quot;K&quot;

forcing&#40;&#91;Ta, Ta, Ta&#93;, h, A, Ta, ϵp, ϵw&#41;</code></pre><pre><code class="plaintext code-output">3-element Vector{Unitful.Quantity{Float64, 𝐋^2 𝐌 𝐓^-3, Unitful.FreeUnits{(W,), 𝐋^2 𝐌 𝐓^-3, nothing}}}:
     -0.0 W
      0.0 W
 3601.225 W</code></pre>
<p>With that last element of the base equation in hands we can derive the time-stepping approach to be used. The derivative term is expanded as a forward finite difference as</p>
\[
\frac{\mathcal{T}_{n+1}-\mathcal{T}_n}{\tau} + \mathbf{L}^\prime\mathcal{T}
=\mathbf{R}^\prime\mathbf{f}
\]
<p>If you go back to the inspection of the inverse inertia matrix above, you will observe that the term corresponding to the gas is about 3 orders of magnitude above the others. That means that the dynamics of that component of the system is much slower than the others and the problem is somewhat stiff. To introduce a first layer of robustness in the integration we can try an implicit scheme by evaluating all terms in the above equation at instant \(n+1\):</p>
\[
\mathcal{T}_{n+1}-\mathcal{T}_n + \tau\mathbf{L}^\prime_{n+1}\mathcal{T}_{n+1}
=\tau\mathbf{R}^\prime_{n+1}\mathbf{f}_{n+1}
\]
<p>This equation can be rearranged by splitting linear terms in \(\mathcal{T}_{n+1}\) on the left-hand side as:</p>
\[
\left(\mathbf{I}+\tau\mathbf{L}^\prime_{n+1}\right)\mathcal{T}_{n+1}=
\tau\mathbf{R}^\prime_{n+1}\mathbf{f}_{n+1}+\mathcal{T}_n
\]
<p>this can be further simplified with the notation:</p>
\[
\mathbf{L}_{n+1}\mathcal{T}_{n+1}=\mathbf{R}_{n+1}+\mathcal{T}_n
\]
<p>It is useful to simplify thing until last step because it tells us what functionalities we need in a computer implementation. The problem of finding \(\mathcal{T}_{n+1}\) can be seem as a nonlinear iteration \(\mathcal{T}_{n+1}=L^{-1}_{n+1}(R_{n+1}+\mathcal{T}_{n})\) followed by update of both \(\mathbf{L}_{n+1}\) and \(\mathbf{R}_{n+1}\) with the new estimate of temperatures. Thus, we  need functions to update both these matrices during the solution. Since these rely on several parameters we can encapsulate then in a higher order function with all fixed parameters and return a function that performs the update for the new temperature estimate, as implemented below.</p>
<pre><code class="language-julia">function buildlhsmatrix&#40;τ, h, A&#41;
    K &#61; stiffness&#40;h, A&#41;
    I &#61; diagm&#40;&#91;1, 1, 1&#93; * 1u&quot;1&quot;&#41;
    return &#40;Tₖ&#41; -&gt; I &#43; τ * inertiainv&#40;Tₖ&#41; * K
end</code></pre>
<pre><code class="language-julia">function buildrhsvector&#40;τ, h, A, Ta, ϵp, ϵw&#41;
    F&#40;T&#41; &#61; τ * forcing&#40;T, h, A, Ta, ϵp, ϵw&#41;
    return &#40;Tₖ&#41; -&gt; inertiainv&#40;Tₖ&#41; * F&#40;Tₖ&#41;
end</code></pre>
<p>As per the previous discussion, the following snipped emulates one time-step iteration:</p>
<pre><code class="language-julia">T &#61; &#91;1273.0u&quot;K&quot;, Ta, Ta&#93;
τ &#61; 1.0u&quot;s&quot;

K &#61; buildlhsmatrix&#40;τ, h, A&#41;
B &#61; buildrhsvector&#40;τ, h, A, Ta, ϵp, ϵw&#41;

# Because of factorization this does not works with Unitful.
# Units are stripped and system becomes inconsistent.
# Tnew &#61; K&#40;T&#41; \ &#40;B&#40;T&#41; .&#43; T&#41;

Tnew &#61; inv&#40;K&#40;T&#41;&#41; * &#40;B&#40;T&#41; .&#43; T&#41;</code></pre><pre><code class="plaintext code-output">3-element Vector{Unitful.Quantity{Float64, 𝚯, Unitful.FreeUnits{(K,), 𝚯, nothing}}}:
 1272.731963441228 K
 348.7875119473756 K
  313.175824937037 K</code></pre>
<p>Function <code>steptime</code> below  performs up to a maximum number of iterations as illustrated above and checks for convergence of the time-step.</p>
<pre><code class="language-julia">function steptime&#40;T₀, K, B; maxiter &#61; 50, rtol &#61; 1.0e-12, β &#61; 1.0&#41;
    Tᵢ &#61; copy&#40;T₀&#41;
    Tⱼ &#61; copy&#40;T₀&#41;
    Δ &#61; 9.0e&#43;100

    for j in range&#40;1, maxiter&#41;
        Tⱼ&#91;:&#93; &#61; inv&#40;K&#40;Tⱼ&#41;&#41; * &#40;B&#40;Tⱼ&#41; .&#43; T₀&#41;
        Tⱼ&#91;:&#93; &#61; relaxation&#40;Tᵢ, Tⱼ, β&#41;
        Δ &#61; residual&#40;Tᵢ, Tⱼ&#41;
        Tᵢ&#91;:&#93; &#61; Tⱼ&#91;:&#93;

        if Δ &lt; rtol
            return Tᵢ, j, Δ
        end
    end

    @warn&#40;&quot;No convergence during step @ &#36;&#40;@sprintf&#40;&quot;&#37;.6e&quot;, Δ&#41;&#41;&quot;&#41;
    return Tᵢ, maxiter, Δ
end</code></pre>
<p>A relaxation step for eventually helping convergence was introduced above as:</p>
<pre><code class="language-julia">relaxation&#40;Tᵢ, Tⱼ, β&#41; &#61; @. β * Tⱼ &#43; &#40;1-β&#41; * Tᵢ</code></pre>
<p>A common choice of residual in this sort of problem is the maximum relative absolute change:</p>
<pre><code class="language-julia">residual&#40;Tᵢ, Tⱼ&#41; &#61; maximum&#40;abs.&#40;Tⱼ .- Tᵢ&#41; ./ Tᵢ&#41;</code></pre>
<p>Time integration is now just a matter of repeating time-stepping and storing solution:</p>
<pre><code class="language-julia">function integrate&#40;t, T, K, B; maxiter, rtol, β&#41;
    U &#61; copy&#40;T&#41;
    nvars &#61; length&#40;T&#41;
    solution &#61; zeros&#40;length&#40;t&#41;, nvars &#43; 2&#41;
    solution&#91;1, 1:nvars&#93; &#61; ustrip&#40;U&#41;

    for &#40;i, tᵢ&#41; in enumerate&#40;t&#91;1:end&#93;&#41;
        &#40;U&#91;:&#93;, niters, Δ&#41; &#61; steptime&#40;U, K, B; maxiter, rtol, β&#41;
        solution&#91;i, 1:nvars&#93; &#61; ustrip&#40;U&#41;
        solution&#91;i, nvars&#43;1&#93; &#61; niters
        solution&#91;i, nvars&#43;2&#93; &#61; Δ
    end

    return solution
end</code></pre>
<p>This completes the tooling for simulation of the process. Below we simulate 24 hours of the dynamics starting with a hot metallic sphere and the furnace equilibrated with the external environment. </p>
<pre><code class="language-julia">tend &#61; 24*3600

T &#61; &#91;1273.0u&quot;K&quot;, Ta, Ta&#93;
t &#61; range&#40;0, tend, convert&#40;Int64, tend / 8&#41;&#41;
τ &#61; step&#40;t&#41; * 1u&quot;s&quot;

K &#61; buildlhsmatrix&#40;τ, h, A&#41;
B &#61; buildrhsvector&#40;τ, h, A, Ta, ϵp, ϵw&#41;

maxiter &#61; 80
rtol &#61; 1.0e-12
β &#61; 0.99

@time solution &#61; integrate&#40;t, T, K, B; maxiter, rtol, β&#41;;</code></pre><pre><code class="plaintext code-output">  0.543864 seconds (2.80 M allocations: 237.647 MiB, 8.96% gc time, 61.38% compilation time)
</code></pre>
<p>Below we can inspect the solution and the residuals at the end of each time-step. For the solution to make sense it is important that every single step must converge during time advancement. Note the leap in gas temperature during the first time steps resulting from the problem stiffness. As a matter of fact, a smaller time-step should have been used for properly resolving its dynamics in the early stages or even better, an adaptative time-stepping approach should have been adopted.</p>


    <figure style="text-align:center;">
      <img src="/medium-articles/assets/content/medium/02-Part-Radiation-Heating/code/output/plot-1.png" style="padding:0; width:100%;" alt=" Problem solution."/>
      <figcaption> Problem solution.</figcaption>
    </figure>
    
<h2 id="using_modelingtoolkit"><a href="#using_modelingtoolkit" class="header-anchor">Using <code>ModelingToolkit</code></a></h2>
<p>In the future...</p>
<div class="note"><div class="title">⚠  Liked my content?</div>
<div class="content">Please help me be able to produce more by becoming     my <a href="https://patreon.com/WallyTutor">Patreon</a>&#33;</div></div>
<div class="page-foot">
    <a href="http://creativecommons.org/licenses/by-sa/4.0/">CC BY-SA 4.0</a> Walter Dal'Maz Silva -
    Built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a>.
</div>
</div><!-- CONTENT ENDS HERE -->
    
        <script src="/medium-articles/libs/katex/katex.min.js"></script>
<script src="/medium-articles/libs/katex/contrib/auto-render.min.js"></script>
<script>renderMathInElement(document.body)</script>

    
    
        <script src="/medium-articles/libs/highlight/highlight.min.js"></script>
<script>hljs.highlightAll();hljs.configure({tabReplace: '    '});</script>

    
  </body>
</html>
